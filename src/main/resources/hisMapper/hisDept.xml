<?xml version="1.0" encoding="UTF-8"?>

<!--
  ~ /*
  ~  *****************************************************************************
  ~  * Copyright ( c ) 2016 Heren Tianjin Inc. All Rights Reserved.
  ~  *
  ~  * This software is the confidential and proprietary information of Heren Tianjin Inc
  ~  * ("Confidential Information").  You shall not disclose such Confidential Information
  ~  *  and shall use it only in accordance with the terms of the license agreement
  ~  *  you entered into with Heren Tianjin or a Heren Tianjin authorized
  ~  *  reseller (the "License Agreement").
  ~  ****************************************************************************
  ~  */
  -->

<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.heren.turtle.server.dao.hisDao.HisDeptDao">

    <resultMap id="deptMapper" type="java.util.Map">
        <result column="dept_name" property="deptName"/>
        <result column="dept_code" property="deptCode"/>
        <result column="ward_code" property="wardCode"/>
        <result column="ward_name" property="wardName"/>
        <result column="ward_alias" property="wardAlias"/>
        <result column="parent_dept_code" property="parentDeptCode"/>
        <result column="dept_alias" property="deptAlias"/>
        <result column="pinyin" property="pinyin"/>
        <result column="parent_dept_name" property="parentDeptName"/>
    </resultMap>

    <select id="queryDeptNameByDeptCode" parameterType="java.lang.String" resultType="java.lang.String">
        select dd.dept_name
        from dept_dict dd
        <where>
            and dd.dept_code=#{deptCode,jdbcType=VARCHAR}
        </where>
    </select>

    <select id="queryWardByDeptCode" parameterType="java.lang.String" resultMap="deptMapper">
        select dvw.ward_code,
        (select d.dept_name
        from dept_dict d
        where d.dept_code=dvw.ward_code) ward_name
        from dept_dict dd,dept_vs_ward dvw
        <where>
            and dvw.dept_code=dd.dept_code
            and dd.dept_code=#{deptCode,jdbcType=VARCHAR}
        </where>
    </select>

    <resultMap id="deptOnlyMapper" type="java.util.Map">
        <result column="dept_name" property="dept_name"/>
        <result column="dept_code" property="dept_code"/>
        <result column="DEPT_ALIAS" property="dept_alias"/>
        <result column="INPUT_CODE" property="pinyin"/>
    </resultMap>

    <select id="queryOnlyDept" resultMap="deptOnlyMapper" parameterType="java.lang.String">
        SELECT
        d.dept_code,
        d.dept_name,
        d.DEPT_ALIAS,
        d.INPUT_CODE
        FROM dept_dict d
        <where>
            <if test="deptCode!=null and deptCode!=''">
                and d.dept_code=#{deptCode,jdbcType=VARCHAR}
            </if>
            and d.dept_code not in (SELECT dvw.ward_code from dept_vs_ward dvw )
        </where>
    </select>

    <resultMap id="wardOnlyMapper" type="java.util.Map">
        <result column="ward_code" property="ward_code"/>
        <result column="dept_code" property="dept_code"/>
        <result column="ward_name" property="ward_name"/>
        <result column="ward_alias" property="ward_alias"/>
        <result column="INPUT_CODE" property="pinyin"/>
    </resultMap>

    <select id="queryOnlyWard" resultMap="wardOnlyMapper" parameterType="java.util.Map">
        SELECT
        d.dept_code as ward_code,
        dw.dept_code,
        d.dept_name as ward_name,
        d.DEPT_ALIAS as ward_alias,
        d.INPUT_CODE
        FROM dept_dict d, dept_vs_ward dw
        <where>
            <if test="wardCode!=null">
                and d.dept_code=#{wardCode,jdbcType=VARCHAR}
            </if>
            <if test="deptCode!=null">
                and dw.dept_code=#{deptCode,jdbcType=VARCHAR}
            </if>
            and d.dept_code in (SELECT dvw.ward_code from dept_vs_ward dvw )
            and d.dept_code=dw.ward_code
        </where>
    </select>

    <resultMap id="transferMapper" type="java.util.Map">
        <result column="patient_id" property="patient_id"/>
        <result column="series" property="series"/>
        <result column="admission_id" property="admission_id"/>
        <result column="turn_in_dept_code" property="turn_in_dept_code"/>
        <result column="turn_in_dept_name" property="turn_in_dept_name"/>
        <result column="turn_in_ward_code" property="turn_in_ward_code"/>
        <result column="turn_in_ward_name" property="turn_in_ward_name"/>
        <result column="turn_in_bed_no" property="turn_in_bed_no"/>
        <result column="turn_in_time" property="turn_in_time"/>
        <result column="turn_out_dept_code" property="turn_out_dept_code"/>
        <result column="turn_out_dept_name" property="turn_out_dept_name"/>
        <result column="turn_out_ward_code" property="turn_out_ward_code"/>
        <result column="turn_out_ward_name" property="turn_out_ward_name"/>
        <result column="turn_out_bed_no" property="turn_out_bed_no"/>
        <result column="turn_out_time" property="turn_out_time"/>
    </resultMap>

    <select id="queryTransfer" resultMap="transferMapper" parameterType="java.util.Map">
        SELECT *
        from ip_mnis_transfer_dept im
        <where>
            <if test="outStartTime!=null">
                and im.turn_in_time>=to_date(#{outStartTime,jdbcType=VARCHAR},'yyyy-MM-dd')
            </if>
            <if test="outEndTime!=null">
                <![CDATA[ and im.turn_in_time<to_date(#{outEndTime,jdbcType=VARCHAR},'yyyy-MM-dd')]]>
            </if>
            <if test="admissionId!=null">
                and im.admission_id=#{admissionId,jdbcType=VARCHAR}
            </if>
        </where>
    </select>

    <select id="queryTransBed" resultMap="transferMapper" parameterType="java.util.Map">
        select *
        from ip_mnis_transfer_bed im
        <where>
            <if test="outStartTime!=null">
                and im.turn_in_time>=to_date(#{outStartTime,jdbcType=VARCHAR},'yyyy-MM-dd')
            </if>
            <if test="outEndTime!=null">
                <![CDATA[ and im.turn_in_time<to_date(#{outEndTime,jdbcType=VARCHAR},'yyyy-MM-dd')]]>
            </if>
            <if test="admissionId!=null">
                and im.admission_id=#{admissionId,jdbcType=VARCHAR}
            </if>
        </where>
    </select>

    <resultMap id="deptMap" type="java.util.Map">
        <result column="dept_code" property="dept_code"/>
        <result column="dept_name" property="dept_name"/>
        <result column="serial_no" property="serial_no"/>
        <result column="dept_alias" property="dis_play_name"/>
        <result column="internal_or_sergery" property="dept_class"/>
    </resultMap>


    <select id="queryNIDept" resultMap="deptMap" parameterType="java.lang.String">
        SELECT
        dd.dept_code,
        dd.dept_name,
        dd.serial_no,
        dd.dept_alias,
        decode(dd.internal_or_sergery, '0', '内科', '1', '外科', '9', '其他', '兼备') AS internal_or_sergery
        FROM dept_dict dd
        <where>
            and dd.clinic_attr NOT IN ('3')
            <if test="deptCode!=null">
                and dd.dept_code=#{deptCode,jdbcType=VARCHAR}
            </if>
        </where>
    </select>

    <resultMap id="transMap" type="java.util.Map">
        <result column="req_no" property="req_no"/>
        <result column="patient_id" property="patient_id"/>
        <result column="visit_id" property="in_hos_sum"/>
        <result column="dept_stayed" property="out_dept_no"/>
        <result column="out_dpet_name" property="out_dpet_name"/>
        <result column="admission_date_time" property="out_dept_date"/>
        <result column="dept_transfered_to" property="in_dept_no"/>
        <result column="in_dept_name" property="in_dept_name"/>
        <result column="discharge_date_time" property="in_dept_date"/>
    </resultMap>

    <select id="queryNiTransfer" resultMap="transMap" parameterType="java.util.Map">
        SELECT
        t.patient_id || '_' || t.visit_id AS req_no,
        t.patient_id,
        t.visit_id,
        t.dept_stayed,
        (SELECT dept_name
        FROM dept_dict dd
        WHERE dd.dept_code = t.dept_stayed) AS out_dpet_name,
        to_char(t.admission_date_time, 'yyyy-MM-dd hh24:mi:ss') AS admission_date_time,
        t.dept_transfered_to,
        (SELECT dept_name
        FROM dept_dict dd
        WHERE dd.dept_code = t.dept_transfered_to) AS in_dept_name,
        to_char(t.discharge_date_time, 'yyyy-MM-dd hh24:mi:ss') AS discharge_date_time
        FROM transfer t
        <where>
            <if test="patientId!=null">
                AND t.patient_id=#{patientId,jdbcType=VARCHAR}
            </if>
            <if test="visitId!=null">
                AND t.VISIT_ID=#{visitId,jdbcType=VARCHAR}
            </if>
            <if test="startTime!=null">
                and t.admission_date_time &gt;=to_date(#{startTime,jdbcType=VARCHAR},'yyyy-MM-dd')
            </if>
            <if test="endTime!=null">
                and t.admission_date_time &lt;to_date(#{endTime,jdbcType=VARCHAR},'yyyy-MM-dd')
            </if>
        </where>
    </select>

</mapper>