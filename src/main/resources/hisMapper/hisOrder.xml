<?xml version="1.0" encoding="UTF-8"?>

<!--
  ~ /*
  ~  *****************************************************************************
  ~  * Copyright ( c ) 2016 Heren Tianjin Inc. All Rights Reserved.
  ~  *
  ~  * This software is the confidential and proprietary information of Heren Tianjin Inc
  ~  * ("Confidential Information").  You shall not disclose such Confidential Information
  ~  *  and shall use it only in accordance with the terms of the license agreement
  ~  *  you entered into with Heren Tianjin or a Heren Tianjin authorized
  ~  *  reseller (the "License Agreement").
  ~  ****************************************************************************
  ~  */
  -->

<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.heren.turtle.server.dao.hisDao.HisOrderDao">

    <resultMap id="orderMapper" type="java.util.Map">
        <result column="order_no" property="orderNo"/>
        <result column="group_no" property="groupNo"/>
        <result column="order_code" property="orderCode"/>
        <result column="order_name" property="orderName"/>
        <result column="patient_id" property="patientId"/>
        <result column="series" property="series"/>
        <result column="admission_id" property="admissionId"/>
        <result column="dept_code" property="deptCode"/>
        <result column="warde_code" property="wardeCode"/>
        <result column="frequency_code" property="frequencyCode"/>
        <result column="dosage" property="dosage"/>
        <result column="dosage_units" property="dosageUnits"/>
        <result column="supply_name" property="supplyName"/>
        <result column="supply_code" property="supplyCode"/>
        <result column="order_status" property="orderStatus"/>
        <result column="order_class" property="orderClass"/>
        <result column="order_class_name" property="orderClassName"/>
        <result column="long_once_flag" property="longOnceFlag"/>
        <result column="start_time" property="startTime"/>
        <result column="enter_time" property="enterTime"/>
        <result column="stop_time" property="stopTime"/>
        <result column="doctor_name" property="doctorName"/>
        <result column="stop_doctor_name" property="stopDoctorName"/>
    </resultMap>

    <select id="queryOrders" parameterType="java.util.Map" resultMap="orderMapper">
        SELECT * from mnis_his_orders_view
        <where>
            <if test="items!=null">
                AND
                <foreach collection="items" item="item" open="ORDER_NO in (" separator="," close=")">
                    #{item,jdbcType=VARCHAR}
                </foreach>
            </if>
            <if test="orderClassItems!=null">
                AND
                <foreach collection="orderClassItems" item="olItems" open="ORDER_CLASS in (" separator=","
                         close=")">
                    #{olItems,jdbcType=VARCHAR}
                </foreach>
            </if>
            <if test="supplyCodeItems!=null">
                AND
                <foreach collection="supplyCodeItems" item="scItems" open="SUPPLY_CODE in (" separator=","
                         close=")">
                    #{scItems,jdbcType=VARCHAR}
                </foreach>
            </if>
            <if test="admissionId!=null">
                and admission_id=#{admissionId,jdbcType=VARCHAR}
            </if>
            <if test="longOnceFlag!=null">
                and long_once_flag=#{longOnceFlag,jdbcType=VARCHAR}
            </if>
            <if test="orderStatus!=null">
                and ORDER_STATUS=#{orderStatus,jdbcType=VARCHAR}
            </if>
            <if test="startTime!=null">
                and start_time &gt;=to_date(#{startTime,jdbcType=VARCHAR},'yyyy-MM-dd')
            </if>
            <if test="endTime!=null">
                and start_time &lt;to_date(#{endTime,jdbcType=VARCHAR},'yyyy-MM-dd')
            </if>
        </where>
    </select>

    <update id="modify" parameterType="java.util.Map">
        UPDATE
        orders
        <set>
            <if test="stopNurseId!=null">
                STOP_NURSE=#{stopNurseId,jdbcType=VARCHAR},
            </if>
            <if test="orderStatus!=null">
                ORDER_STATUS=#{orderStatus,jdbcType=VARCHAR},
            </if>
            <if test="stopOrderDateTime!=null">
                STOP_DATE_TIME=to_date(#{stopOrderDateTime,jdbcType=VARCHAR},'yyyy-MM-dd hh24:mi:ss'),
            </if>
            <if test="lastPerformDateTime!=null">
                LAST_PERFORM_DATE_TIME=to_date(#{lastPerformDateTime,jdbcType=VARCHAR},'yyyy-MM-dd hh24:mi:ss'),
            </if>
        </set>
        <where>
            <if test="patientId!=null">
                AND patient_id=#{patient_id,jdbcType=VARCHAR}
            </if>
            <if test="series!=null">
                AND VISIT_ID=#{series,jdbcType=VARCHAR}
            </if>
            <if test="orderNo!=null">
                AND ORDER_NO=#{orderNo,jdbcType=VARCHAR}
            </if>
            <if test="groupNo!=null">
                AND ORDER_SUB_NO=#{groupNo,jdbcType=VARCHAR}
            </if>
        </where>
    </update>

    <resultMap id="orderNiMapper" type="java.util.Map">
        <result column="req_no" property="req_no"/>
        <result column="patient_id" property="patient_id"/>
        <result column="visit_id" property="in_hos_sum"/>
        <result column="doc_adv_no" property="doc_adv_no"/>
        <result column="order_text" property="doc_advice"/>
        <result column="start_date_time" property="beg_time"/>
        <result column="stop_date_time" property="end_time"/>
        <result column="administration" property="exe_mode"/>
        <result column="dosage" property="dosage"/>
        <result column="dosage_units" property="dos_unit"/>
        <result column="repeat_indicator" property="doc_adv_type"/>
        <result column="doctor" property="doctor"/>
        <result column="ordering_dept" property="dist_no"/>
    </resultMap>

    <select id="queryNiOrder" resultMap="orderNiMapper" parameterType="java.util.Map">
        SELECT
        o.patient_id || '_' || o.visit_id AS req_no,
        o.patient_id,
        o.visit_id,
        o.order_no || '_' || o.order_sub_no AS doc_adv_no,
        o.order_text,
        to_char(o.start_date_time, 'yyyy-MM-dd hh24:mi:ss'),
        (CASE
        WHEN o.stop_date_time IS NULL AND o.repeat_indicator = '1'
        THEN '1900-01-01 00:00:00'
        ELSE
        to_char(o.stop_date_time, 'yyyy-MM-dd hh24:mi:ss')
        END) AS stop_date_time,
        o.administration,
        o.dosage,
        o.dosage_units,
        decode(o.repeat_indicator, 1, '长期', 0, '临时') AS repeat_indicator,
        o.doctor,
        o.ordering_dept
        FROM orders o
        <where>
            <if test="patientId!=null">
                AND patient_id=#{patientId,jdbcType=VARCHAR}
            </if>
            <if test="visitId!=null">
                AND VISIT_ID=#{visitId,jdbcType=VARCHAR}
            </if>
            <if test="startTime!=null">
                and start_time &gt;=to_date(#{startTime,jdbcType=VARCHAR},'yyyy-MM-dd')
            </if>
            <if test="endTime!=null">
                and start_time &lt;to_date(#{endTime,jdbcType=VARCHAR},'yyyy-MM-dd')
            </if>
        </where>
    </select>

</mapper>