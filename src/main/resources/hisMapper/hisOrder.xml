<?xml version="1.0" encoding="UTF-8"?>

<!--
  ~ /*
  ~  *****************************************************************************
  ~  * Copyright ( c ) 2016 Heren Tianjin Inc. All Rights Reserved.
  ~  *
  ~  * This software is the confidential and proprietary information of Heren Tianjin Inc
  ~  * ("Confidential Information").  You shall not disclose such Confidential Information
  ~  *  and shall use it only in accordance with the terms of the license agreement
  ~  *  you entered into with Heren Tianjin or a Heren Tianjin authorized
  ~  *  reseller (the "License Agreement").
  ~  ****************************************************************************
  ~  */
  -->

<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.heren.turtle.server.dao.hisDao.HisOrderDao">

    <resultMap id="orderMapper" type="java.util.Map">
        <result column="order_no" property="order_no"/>
        <result column="group_no" property="group_no"/>
        <result column="order_code" property="order_code"/>
        <result column="order_name" property="order_name"/>
        <result column="drug_name" property="drug_name"/>
        <result column="patient_id" property="patient_id"/>
        <result column="series" property="series"/>
        <result column="admission_id" property="admission_id"/>
        <result column="dept_code" property="dept_code"/>
        <result column="warde_code" property="ward_code"/>
        <result column="frequency_code" property="frequency_code"/>
        <result column="dosage" property="dosage"/>
        <result column="dosage_units" property="dosage_units"/>
        <result column="supply_name" property="supply_name"/>
        <result column="supply_code" property="supply_code"/>
        <result column="order_status" property="order_status"/>
        <result column="order_class" property="order_class"/>
        <result column="order_class_name" property="order_class_name"/>
        <result column="long_once_flag" property="long_once_flag"/>
        <result column="start_time" property="start_time"/>
        <result column="enter_time" property="enter_time"/>
        <result column="stop_time" property="stop_time"/>
        <result column="doctor_name" property="doctor_name"/>
        <result column="stop_doctor_name" property="stop_doctor_name"/>
    </resultMap>

    <select id="queryOrders" parameterType="java.util.Map" resultMap="orderMapper">
        SELECT * from ip_mnis_order_view
        <where>
            <if test="items!=null">
                AND
                <foreach collection="items" item="item" open="ORDER_NO in (" separator="," close=")">
                    #{item,jdbcType=VARCHAR}
                </foreach>
            </if>
            <if test="orderClassItems!=null">
                AND
                <foreach collection="orderClassItems" item="olItems" open="ORDER_CLASS in (" separator=","
                         close=")">
                    #{olItems,jdbcType=VARCHAR}
                </foreach>
            </if>
            <if test="supplyCodeItems!=null">
                AND
                <foreach collection="supplyCodeItems" item="scItems" open="SUPPLY_CODE in (" separator=","
                         close=")">
                    #{scItems,jdbcType=VARCHAR}
                </foreach>
            </if>
            <if test="patientId!=null">
                and patient_id=#{patientId,jdbcType=VARCHAR}
            </if>
            <if test="series!=null">
                and series=#{series,jdbcType=VARCHAR}
            </if>
            <if test="longOnceFlag!=null">
                and long_once_flag=#{longOnceFlag,jdbcType=VARCHAR}
            </if>
            <if test="orderStatus!=null">
                and ORDER_STATUS=#{orderStatus,jdbcType=VARCHAR}
            </if>
            <if test="deptCode!=null">
                and dept_code=#{deptCode,jdbcType=VARCHAR}
            </if>
            <if test="startTime!=null">
                and start_time>=to_date(#{startTime,jdbcType=VARCHAR},'yyyy-MM-dd')
            </if>
            <if test="endTime!=null">
                <![CDATA[ and start_time<to_date(#{endTime,jdbcType=VARCHAR},'yyyy-MM-dd')]]>
            </if>
        </where>
    </select>

    <update id="modify" parameterType="java.util.Map">
        UPDATE
        orders
        <set>
            <if test="stopNurseId!=null">
                STOP_NURSE=#{stopNurseId,jdbcType=VARCHAR},
            </if>
            <if test="orderStatus!=null">
                ORDER_STATUS=#{orderStatus,jdbcType=VARCHAR},
            </if>
            <if test="stopOrderDateTime!=null">
                STOP_DATE_TIME=to_date(#{stopOrderDateTime,jdbcType=VARCHAR},'yyyy-MM-dd hh24:mi:ss'),
            </if>
            <if test="updateTime!=null">
                LAST_PERFORM_DATE_TIME=to_date(#{updateTime,jdbcType=VARCHAR},'yyyy-MM-dd hh24:mi:ss'),
            </if>
            <if test="updateBy!=null">
                performed_by=#{updateBy,jdbcType=VARCHAR},
            </if>
        </set>
        <where>
            <if test="patientId!=null">
                AND patient_id=#{patientId,jdbcType=VARCHAR}
            </if>
            <if test="series!=null">
                AND VISIT_ID=#{series,jdbcType=VARCHAR}
            </if>
            <if test="orderNo!=null">
                AND ORDER_NO=#{orderNo,jdbcType=VARCHAR}
            </if>
            <if test="groupNo!=null">
                AND ORDER_SUB_NO=#{groupNo,jdbcType=VARCHAR}
            </if>
        </where>
    </update>

    <resultMap id="orderNiMapper" type="java.util.Map">
        <result column="req_no" property="req_no"/>
        <result column="patient_id" property="patient_id"/>
        <result column="visit_id" property="in_hos_sum"/>
        <result column="doc_adv_no" property="doc_adv_no"/>
        <result column="order_text" property="doc_advice"/>
        <result column="start_date_time" property="beg_time"/>
        <result column="stop_date_time" property="end_time"/>
        <result column="administration" property="exe_mode"/>
        <result column="dosage" property="dosage"/>
        <result column="dosage_units" property="dos_unit"/>
        <result column="repeat_indicator" property="doc_adv_type"/>
        <result column="doctor" property="doctor"/>
        <result column="ordering_dept" property="dist_no"/>
    </resultMap>

    <select id="queryNiOrder" resultMap="orderNiMapper" parameterType="java.util.Map">
        SELECT
        o.patient_id || '_' || o.visit_id AS req_no,
        o.patient_id,
        o.visit_id,
        o.order_no || '_' || o.order_sub_no AS doc_adv_no,
        o.order_text,
        to_char(o.start_date_time, 'yyyy-MM-dd hh24:mi:ss') as start_date_time,
        (CASE
        WHEN o.stop_date_time IS NULL AND o.repeat_indicator = '1'
        THEN '1900-01-01 00:00:00'
        WHEN o.stop_date_time IS NULL AND o.repeat_indicator = '0'
        THEN to_char(o.start_date_time,'yyyy-MM-dd hh24:mi:ss')
        ELSE
        to_char(o.stop_date_time, 'yyyy-MM-dd hh24:mi:ss')
        END) AS stop_date_time,
        o.administration,
        o.dosage,
        o.dosage_units,
        decode(o.repeat_indicator, 1, '长期', 0, '临时') AS repeat_indicator,
        o.doctor,
        o.ordering_dept
        FROM orders o
        <where>
            <if test="patientId!=null">
                AND patient_id=#{patientId,jdbcType=VARCHAR}
            </if>
            <if test="visitId!=null">
                AND VISIT_ID=#{visitId,jdbcType=VARCHAR}
            </if>
            <if test="startTime!=null">
                and start_time &gt;=to_date(#{startTime,jdbcType=VARCHAR},'yyyy-MM-dd')
            </if>
            <if test="endTime!=null">
                and start_time &lt;to_date(#{endTime,jdbcType=VARCHAR},'yyyy-MM-dd')
            </if>
        </where>
    </select>

    <resultMap id="drugNiMapper" type="java.util.Map">
        <result column="req_no" property="req_no"/>
        <result column="patient_id" property="patient_id"/>
        <result column="visit_id" property="in_hos_sum"/>
        <result column="order_no" property="use_order_no"/>
        <result column="order_code" property="medi_id"/>
        <result column="order_text" property="medi_name"/>
        <result column="administration" property="medi_Path"/>
        <result column="dosage" property="dosage"/>
        <result column="dosage_units" property="unit"/>
        <result column="start_date_time" property="begin_time"/>
        <result column="REPEAT_INDICATOR" property="doc_adv_type"/>
        <result column="FREQUENCY" property="frequency"/>
        <result column="DOCTOR" property="doctor"/>
        <result column="ORDERING_DEPT" property="dict_no"/>
        <result column="stop_date_time" property="end_time"/>
    </resultMap>

    <select id="queryNiDrug" resultMap="drugNiMapper" parameterType="java.util.Map">
        SELECT
        o.patient_id || '_' || o.visit_id AS req_no,
        o.patient_id,
        o.visit_id,
        o.order_no || '_' || o.order_sub_no AS order_no,
        o.order_code,
        o.order_text,
        o.administration,
        o.dosage,
        o.dosage_units,
        to_char(o.start_date_time,'yyyy-MM-dd hh24:mi:ss') as start_date_time,
        (CASE
        WHEN o.stop_date_time IS NULL AND o.repeat_indicator = '1'
        THEN '1900-01-01 00:00:00'
        WHEN o.stop_date_time IS NULL AND o.repeat_indicator = '0'
        THEN to_char(o.start_date_time,'yyyy-MM-dd hh24:mi:ss')
        ELSE
        to_char(o.stop_date_time, 'yyyy-MM-dd hh24:mi:ss')
        END) AS stop_date_time,
        decode(o.REPEAT_INDICATOR,'1','长期','0','临时','其他') as REPEAT_INDICATOR,
        o.FREQUENCY,
        o.DOCTOR,
        o.ORDERING_DEPT
        FROM orders o
        <where>
            <if test="patientId!=null">
                AND o.patient_id=#{patientId,jdbcType=VARCHAR}
            </if>
            <if test="visitId!=null">
                AND o.VISIT_ID=#{visitId,jdbcType=VARCHAR}
            </if>
            <if test="startTime!=null">
                and o.start_date_time &gt;=to_date(#{startTime,jdbcType=VARCHAR},'yyyy-MM-dd')
            </if>
            <if test="endTime!=null">
                and o.start_date_time &lt;to_date(#{endTime,jdbcType=VARCHAR},'yyyy-MM-dd')
            </if>
            AND o.order_class = 'A'
            AND substr(o.order_code, 0, 2) IN ('01', '02')
        </where>
    </select>

</mapper>